<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>連絡・情報共有フォーム</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; line-height: 1.6; }
    form { max-width: 720px; }
    fieldset { border: 1px solid #ddd; padding: 16px; margin-bottom: 20px; }
    label { display: block; font-weight: 600; margin: 10px 0 6px; }
    input[type="text"], textarea {
      width: 100%; box-sizing: border-box; padding: 8px; font-size: 16px;
      border: 1px solid #bbb; border-radius: 6px;
    }
    input[type="file"] { display: block; margin-top: 6px; }
    button { padding: 10px 16px; font-size: 16px; border-radius: 6px; }
    #log { white-space: pre-wrap; background: #fafafa; border: 1px solid #eee; padding: 12px; margin-top: 16px; }
    .ok { color: #137333; }
    .ng { color: #b80606; }
  </style>
</head>
<body>
  <h1>連絡・情報共有フォーム</h1>

  <form id="f">
    <fieldset>
      <legend>テキスト入力(すべて入力必須)</legend>
      <label for="t2">ユーザー名</label>
      <input id="t2" name="t2" type="text" placeholder="ニックネーム・名前など(仮でOK)" required />
      <label for="t3">要件</label>
      <input id="t3" name="t3" type="text" placeholder="バグ報告/意見/質問など" required />
      <label for="t1">内容</label>
      <textarea id="t1" name="t1" rows="5" placeholder="内容の詳細を記載" required></textarea>
    </fieldset>

    <fieldset>
      <legend>ファイル(サイズ制限あり/1回の送信に30秒以上かかる場合エラー?)
        <br>ファイル送信ができない場合は、ファイル共有のURLでお送りいただけると幸いです。
      </legend>
      <label for="img">画像（accept=image/*）</label>
      <input id="img" name="img" type="file" accept="image/*" />

      <label for="vid">動画（accept=video/*）</label>
      <input id="vid" name="vid" type="file" accept="video/*" />
    </fieldset>

    <button type="submit">送信</button>
  </form>

  <div id="log" aria-live="polite"></div>

  <script>
  // ====== 設定（あなたのGAS WebアプリURLに差し替えてください） ======
  // GAS 側は doPost(e) を実装し、本文(JSON)を UTF-8 で受けて処理します:
  //   const body = JSON.parse(e.postData.getDataAsString('UTF-8') || '{}');
  //   switch(body.type) { 'doc' | 'sheet' | 'upload' ... }
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbxbNpuo9t87jruH2lHbeS1ML3hOy9MFloCpbnyOpU9lnNBPoCL3TmDRpUxABFeo9Njcbw/exec';
  //const GAS_ID = '..................................AKfycbxbNpuo9t87jruH2lHbeS1ML3hOy9MFloCpbnyOpU9lnNBPoCL3TmDRpUxABFeo9Njcbw';
    
  // （任意）簡易トークン。GAS 側で PropertiesService などに保存して照合推奨
  const TOKEN = ''; // 使う場合は文字列を入れて、payload.token に同梱

  // ====== ユーティリティ ======
  function log(msg, ok) {
    var el = document.getElementById('log');
    var p = document.createElement('div');
    p.className = ok === true ? 'ok' : ok === false ? 'ng' : '';
    p.textContent = msg;
    el.appendChild(p);
  }

  function postJSON(obj) {
    return fetch(GAS_URL, {
      method: 'POST',
      // ヘッダは付けない（ブラウザが text/plain で送る＝プリフライト回避）
      body: JSON.stringify(obj)
    }).then(async (r) => {
      const t = await r.text();     // 念のためテキストで受ける
      try { return JSON.parse(t); } // JSONに変換
      catch { return { ok:false, error:'Bad JSON: '+t.slice(0,200) }; }
    });
  }

  // File → data:URL（Base64）へ。巨大ファイルは非推奨
  function fileToDataURL(file) {
    return new Promise(function(resolve, reject){
      var reader = new FileReader();
      reader.onload = function(){ resolve(reader.result); }; // "data:...;base64,AAAA"
      reader.onerror = function(){ reject(reader.error); };
      reader.readAsDataURL(file);
    });
  }

  // ====== 送信フロー（4リクエスト：Doc → Sheet → 画像 → 動画） ======
  document.getElementById('f').addEventListener('submit', async function(e){
    e.preventDefault();
    document.getElementById('log').textContent = ''; // クリア

    var t1 = document.getElementById('t1').value || '';
    var t2 = document.getElementById('t2').value || '';
    var t3 = document.getElementById('t3').value || '';
    var imgFile = document.getElementById('img').files[0] || null;
    var vidFile = document.getElementById('vid').files[0] || null;

    try {
      // 1) Google ドキュメントへ追記
      // { type: 'doc', text: '本文', token }
      var res1 = await postJSON({ type: 'doc', text: t1, token: TOKEN });
      if (!res1 || !res1.ok) throw new Error(res1 && res1.error || 'テキスト送信失敗');

      // 2) Google スプレッドシートへ 1行追記（A列=t2, B列=t3 など）
      // { type: 'sheet', sheetName: 'Responses', rows: [[t2, t3]], token }
      var res2 = await postJSON({
        type: 'sheet',
        sheetName: 'Responses', // GAS 側で存在チェック
        rows: [[t2, t3]],
        token: TOKEN
      });
      if (!res2 || !res2.ok) throw new Error(res2 && res2.error || 'テキスト送信失敗');


      // 3) 画像を Drive へ（任意）
      if (imgFile) {
        var imgDataUrl = await fileToDataURL(imgFile);
        // 期待ペイロード例:
        // { type: 'upload', kind: 'image', filename, mimeType, dataUrl, token }
        var res3 = await postJSON({
          type: 'upload',
          kind: 'image',
          filename: imgFile.name,
          mimeType: imgFile.type || 'application/octet-stream',
          dataUrl: imgDataUrl,
          token: TOKEN
        });
        if (!res3 || !res3.ok) throw new Error(res3 && res3.error || '画像アップロード失敗');
        log('画像を送信しました');
        //log('画像を送信しました: ' + (res3.url || ('fileId=' + res3.fileId)), true);
      } else {
        log('画像なし（スキップ）');
      }

      // 4) 動画を Drive へ（任意・小さめ推奨）
      if (vidFile) {
        var vidDataUrl = await fileToDataURL(vidFile);
        var res4 = await postJSON({
          type: 'upload',
          kind: 'video',
          filename: vidFile.name,
          mimeType: vidFile.type || 'application/octet-stream',
          dataUrl: vidDataUrl,
          token: TOKEN
        });
        if (!res4 || !res4.ok) throw new Error(res4 && res4.error || '動画アップロード失敗');
        log('動画を送信しました');
        //log('動画を送信しました: ' + (res4.url || ('fileId=' + res4.fileId)), true);
      } else {
        log('動画なし（スキップ）');
      }
      log('すべて完了しました。', true);
    } catch (err) {
      log('エラー: ' + (err && err.message ? err.message : String(err)), false);
    }
  });
  </script>
</body>
</html>
